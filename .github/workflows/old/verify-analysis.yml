name: Verify Checkov CI VPC Result

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      checkov_vpc_status: ${{ steps.checkov-result.outputs.status }}

    steps:
      # Step 1: Find latest workflow run and the artifact
      - name: Resolve checkov-ci-vpc artifact
        id: artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowFile = "tf-static-analysis.yml";
            const { owner, repo } = context.repo;

            // get the latest completed run
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setFailed("No completed workflow runs found");
              return;
            }

            const runId = runs.data.workflow_runs[0].id;
            core.info(`Using workflow run ID: ${runId}`);

            // list artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });

            const checkovArtifact = artifacts.data.artifacts.find(a => a.name === "checkov-ci-vpc");

            if (!checkovArtifact) {
              core.setFailed("Artifact checkov-ci-vpc not found");
              return;
            }

            core.setOutput("artifact_url", checkovArtifact.archive_download_url)

      # Step 2: Download artifact, print result.txt, and set output
      - name: Download and verify checkov-ci-vpc
        id: checkov-result
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ARTIFACT_URL="${{ steps.artifact.outputs.artifact_url }}"
          ARTIFACT_NAME="checkov-ci-vpc"

          echo "üîç Downloading $ARTIFACT_NAME"
          curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$ARTIFACT_URL" \
            -o "$ARTIFACT_NAME.zip"

          unzip -o "$ARTIFACT_NAME.zip" -d "$ARTIFACT_NAME"

          RESULT_FILE="$ARTIFACT_NAME/result.txt"

          if [[ ! -f "$RESULT_FILE" ]]; then
            echo "‚ùå result.txt missing!"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "üìÑ Contents of $RESULT_FILE:"
          cat "$RESULT_FILE"
          echo "-------------------------"

          # Read status
          STATUS=$(grep -Eo "status=.+$" "$RESULT_FILE" | cut -d= -f2)

          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [[ "$STATUS" != "success" ]]; then
            echo "‚ùå Checkov CI VPC job failed!"
            exit 1
          else
            echo "‚úÖ Checkov CI VPC job succeeded!"
          fi

      # Step 3: Demonstrate a conditional step using the job output
      - name: Conditional step if Checkov passed
        if: ${{ steps.checkov-result.outputs.status == 'success' }}
        run: |
          echo "üéâ Checkov CI VPC succeeded, running this conditional step!"
