
name: Verify Checkov CI VPC Result

on:
  workflow_call:
    inputs:
      artifact_name:
        description: "Name of the artifact to download"
        required: false
        default: "checkov-ci-vpc"
        type: string

    outputs:
      checkov_vpc_status:
        description: "Status of the Checkov CI VPC run"
        value: ${{ steps.checkov-result.outputs.status }}

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      checkov_vpc_status: ${{ steps.checkov-result.outputs.status }}

    steps:
      # Step 1: Download the artifact
      - name: Download artifact
        id: checkov-result
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: checkov-artifact

      # Step 2: Read the result.txt and set output
      - name: Read Checkov result
        run: |
          set -euo pipefail
          RESULT_FILE="checkov-artifact/result.txt"

          if [[ ! -f "$RESULT_FILE" ]]; then
            echo "‚ùå result.txt missing!"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "üìÑ Contents of $RESULT_FILE:"
          cat "$RESULT_FILE"
          echo "-------------------------"

          STATUS=$(grep -Eo "status=.+$" "$RESULT_FILE" | cut -d= -f2)

          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [[ "$STATUS" != "success" ]]; then
            echo "‚ùå Checkov job failed!"
            exit 1
          else
            echo "‚úÖ Checkov job succeeded!"



