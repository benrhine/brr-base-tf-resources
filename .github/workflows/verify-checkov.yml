
name: Verify Checkov Artifacts

on:
  workflow_call:
    inputs:
      github-token:
        required: true
        type: string
    outputs:
      checkov_account_resources:
        value: ${{ jobs.verify.outputs.account_resources }}
      checkov_ci_vpc:
        value: ${{ jobs.verify.outputs.ci_vpc }}
      checkov_ci_eks_cluster:
        value: ${{ jobs.verify.outputs.ci_eks_cluster }}
      checkov_ci_kube_argo:
        value: ${{ jobs.verify.outputs.ci_kube_argo }}

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      account_resources: ${{ steps.read.outputs.account_resources }}
      ci_vpc: ${{ steps.read.outputs.ci_vpc }}
      ci_eks_cluster: ${{ steps.read.outputs.ci_eks_cluster }}
      ci_kube_argo: ${{ steps.read.outputs.ci_kube_argo }}

    steps:
      - name: Download latest Checkov artifact
        id: read
        uses: actions/github-script@v7
        with:
          github-token: ${{ inputs.github-token }}
          script: |
            const artifactsToCheck = [
              "checkov-account-resources",
              "checkov-ci-vpc",
              "checkov-ci-eks-cluster",
              "checkov-ci-kube-argo"
            ];

            const { owner, repo } = context.repo;

            const outputs = {};

            for (const artifactName of artifactsToCheck) {
              // find latest workflow run
              const runs = await github.rest.actions.listWorkflowRuns({
                owner,
                repo,
                workflow_id: "tf-static-analysis.yml",
                status: "completed",
                per_page: 10
              });

              if (!runs.data.workflow_runs.length) {
                outputs[artifactName] = "failure";
                continue;
              }

              const runId = runs.data.workflow_runs[0].id;

              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner,
                repo,
                run_id: runId
              });

              const artifact = artifacts.data.artifacts.find(a => a.name === artifactName);

              if (!artifact) {
                outputs[artifactName] = "failure";
                continue;
              }

              const download = await github.rest.actions.downloadArtifact({
                owner,
                repo,
                artifact_id: artifact.id,
                archive_format: "zip"
              });

              // Save zip locally
              const fs = require('fs');
              const AdmZip = require('adm-zip');
              const zip = new AdmZip(Buffer.from(download.data, 'base64'));
              zip.extractAllTo(artifactName, true);

              const resultFile = `${artifactName}/result.txt`;
              if (!fs.existsSync(resultFile)) {
                outputs[artifactName] = "failure";
                continue;
              }

              const content = fs.readFileSync(resultFile, "utf8");
              const match = content.match(/status=(\w+)/);
              outputs[artifactName] = match ? match[1] : "failure";
            }

            return outputs;
