
name: Verify Checkov Artifacts

on:
  workflow_call:
    inputs:
      github-token:
        required: true
        type: string
    outputs:
      checkov_account_resources:
        value: ${{ jobs.verify.outputs.account_resources }}
      checkov_ci_vpc:
        value: ${{ jobs.verify.outputs.ci_vpc }}
      checkov_ci_eks_cluster:
        value: ${{ jobs.verify.outputs.ci_eks_cluster }}
      checkov_ci_kube_argo:
        value: ${{ jobs.verify.outputs.ci_kube_argo }}

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      account_resources: ${{ steps.read.outputs.account_resources }}
      ci_vpc: ${{ steps.read.outputs.ci_vpc }}
      ci_eks_cluster: ${{ steps.read.outputs.ci_eks_cluster }}
      ci_kube_argo: ${{ steps.read.outputs.ci_kube_argo }}

    steps:
      - name: Download Checkov Artifacts
        id: download
        uses: actions/github-script@v7
        with:
          github-token: ${{ inputs.github-token }}
          script: |
            const { owner, repo } = context.repo;
            const workflowFile = "tf-static-analysis.yml";

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setFailed("No completed workflow runs found");
              return;
            }

            const runId = runs.data.workflow_runs[0].id;
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });

            const output = {};
            ["checkov-account-resources","checkov-ci-vpc","checkov-ci-eks-cluster","checkov-ci-kube-argo"].forEach(name => {
              const art = artifacts.data.artifacts.find(a => a.name === name);
              output[name] = art ? art.archive_download_url : "";
            });

            return output;

      - name: Read and set outputs
        id: read
        run: |
          for a in "checkov-account-resources" "checkov-ci-vpc" "checkov-ci-eks-cluster" "checkov-ci-kube-argo"; do
            URL=$(jq -r .\"$a\" <<< "${{ steps.download.outputs.result }}")
            if [[ -z "$URL" || "$URL" == "null" ]]; then
              echo "$a=failure" >> $GITHUB_OUTPUT
            else
              # Download artifact, unzip, read result.txt
              curl -sSL -H "Authorization: Bearer ${{ inputs.github-token }}" -L "$URL" -o artifact.zip
              unzip -o artifact.zip -d tmp
              STATUS=$(grep -Eo "status=.+$" tmp/result.txt | cut -d= -f2)
              echo "$a=$STATUS" >> $GITHUB_OUTPUT
            fi
          done
