
name: Verify Single Checkov Result

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
    outputs:
      status:
        description: "Status of the project"
        value: ${{ steps.checkov-result.outputs.status }}

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve artifact
        id: artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowFile = "tf-static-analysis.yml";
            const { owner, repo } = context.repo;

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setFailed("No completed workflow runs found");
              return;
            }

            const runId = runs.data.workflow_runs[0].id;
            core.info(`Using workflow run ID: ${runId}`);

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });

            const artifact = artifacts.data.artifacts.find(a => a.name === "${{ inputs.artifact_name }}");
            if (!artifact) {
              core.setFailed(`Artifact ${{ inputs.artifact_name }} not found`);
              return;
            }

            core.setOutput("artifact_url", artifact.archive_download_url);

      - name: Download artifact and extract status
        id: checkov-result
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          ARTIFACT_NAME="${{ inputs.artifact_name }}"
          ARTIFACT_URL="${{ steps.artifact.outputs.artifact_url }}"

          curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$ARTIFACT_URL" \
            -o "$ARTIFACT_NAME.zip"

          unzip -o "$ARTIFACT_NAME.zip" -d "$ARTIFACT_NAME"

          RESULT_FILE="$ARTIFACT_NAME/result.txt"

          if [[ ! -f "$RESULT_FILE" ]]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

          STATUS=$(grep -Eo "status=.+$" "$RESULT_FILE" | cut -d= -f2)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
