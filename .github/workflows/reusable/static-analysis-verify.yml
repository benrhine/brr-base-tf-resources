name: Reusable Static Analysis Verification

on:
  workflow_call:
    inputs:
      artifact-name:
        description: "Name of the checkov artifact to verify"
        required: true
        type: string
      workflow-file:
        description: "Workflow file that generated the artifact"
        required: false
        type: string
        default: "tf-static-analysis.yml"
    outputs:
      status:
        description: "Status of the checkov verification (success/failure)"
        value: ${{ jobs.verify.outputs.status }}
      artifact-found:
        description: "Whether the artifact was found"
        value: ${{ jobs.verify.outputs.artifact-found }}

jobs:
  verify:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.checkov-result.outputs.status }}
      artifact-found: ${{ steps.checkov-result.outputs.artifact-found }}

    steps:
      # Step 1: Find latest workflow run and the artifact
      - name: Resolve checkov artifact
        id: artifact
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowFile = "${{ inputs.workflow-file }}";
            const artifactName = "${{ inputs.artifact-name }}";
            const { owner, repo } = context.repo;

            core.info(`Looking for artifact: ${artifactName} from workflow: ${workflowFile}`);

            // get the latest completed run
            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setFailed("No completed workflow runs found");
              return;
            }

            const runId = runs.data.workflow_runs[0].id;
            core.info(`Using workflow run ID: ${runId}`);

            // list artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });

            const checkovArtifact = artifacts.data.artifacts.find(a => a.name === artifactName);

            if (!checkovArtifact) {
              core.setFailed(`Artifact ${artifactName} not found`);
              return;
            }

            core.setOutput("artifact_url", checkovArtifact.archive_download_url);
            core.info(`Found artifact at: ${checkovArtifact.archive_download_url}`);

      # Step 2: Download artifact, print result.txt, and set output
      - name: Download and verify checkov artifact
        id: checkov-result
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACT_NAME: ${{ inputs.artifact-name }}
        run: |
          set -euo pipefail

          ARTIFACT_URL="${{ steps.artifact.outputs.artifact_url }}"

          echo "üîç Downloading $ARTIFACT_NAME"
          curl -sSL \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$ARTIFACT_URL" \
            -o "$ARTIFACT_NAME.zip"

          unzip -o "$ARTIFACT_NAME.zip" -d "$ARTIFACT_NAME"

          RESULT_FILE="$ARTIFACT_NAME/result.txt"

          if [[ ! -f "$RESULT_FILE" ]]; then
            echo "‚ùå result.txt missing!"
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "artifact-found=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "artifact-found=true" >> $GITHUB_OUTPUT

          echo "üìÑ Contents of $RESULT_FILE:"
          cat "$RESULT_FILE"
          echo "-------------------------"

          # Read status
          STATUS=$(grep -Eo "status=.+$" "$RESULT_FILE" | cut -d= -f2)

          echo "status=$STATUS" >> $GITHUB_OUTPUT

          if [[ "$STATUS" != "success" ]]; then
            echo "‚ùå Checkov verification failed for $ARTIFACT_NAME!"
            exit 1
          else
            echo "‚úÖ Checkov verification succeeded for $ARTIFACT_NAME!"
          fi