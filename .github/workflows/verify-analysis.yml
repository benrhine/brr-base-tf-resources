name: Verify Terraform Static Analysis Results

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve Checkov artifacts
        id: artifacts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowFile = "tf-static-analysis.yml";
            const { owner, repo } = context.repo;

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setFailed("No completed workflow runs found");
              return;
            }

            const runId = runs.data.workflow_runs[0].id;
            core.info(`Using workflow run ID: ${runId}`);

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });

            const checkov = artifacts.data.artifacts.filter(a =>
              a.name.startsWith("checkov")
            );

            if (!checkov.length) {
              core.setFailed("No Checkov artifacts found");
              return;
            }

            core.setOutput(
              "artifacts",
              JSON.stringify(checkov.map(a => ({
                name: a.name,
                url: a.archive_download_url
              })))
            );

      - name: Download and validate Checkov results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARTIFACTS: ${{ steps.artifacts.outputs.artifacts }}
        run: |
          set -euo pipefail
          
          echo "$ARTIFACTS" | jq -c '.[]' | while read artifact; do
            name=$(echo "$artifact" | jq -r '.name')
            url=$(echo "$artifact" | jq -r '.url')
          
            echo "üîç Processing artifact: $name"
          
            # Download the artifact zip
            curl -sSL \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "$url" \
              -o "$name.zip"
          
            # Extract it
            unzip -o "$name.zip" -d "$name"
          
            # Check that result.txt exists
            result_file="$name/result.txt"
            if [[ ! -f "$result_file" ]]; then
              echo "‚ùå Missing result.txt in $name"
              exit 1
            fi
          
            # Print the contents of the file
            echo "üìÑ Contents of $result_file:"
            cat "$result_file"
            echo "-------------------------"
          
            # Check if it says success
            if ! grep -q "status=success" "$result_file"; then
              echo "‚ùå Checkov failure in $name"
              exit 1
            fi
          
            echo "‚úÖ $name passed"
            echo ""
          done
          
          echo "üéâ All Checkov jobs passed"
