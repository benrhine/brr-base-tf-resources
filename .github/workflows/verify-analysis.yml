name: Verify Terraform Static Analysis Results

on:
  workflow_dispatch:

jobs:
  verify:
    runs-on: ubuntu-latest

    steps:
      - name: Resolve Checkov artifacts
        id: artifacts
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowFile = "tf-static-analysis.yml";
            const { owner, repo } = context.repo;

            const runs = await github.rest.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: workflowFile,
              status: "completed",
              per_page: 1,
            });

            if (!runs.data.workflow_runs.length) {
              core.setFailed("No completed workflow runs found");
              return;
            }

            const runId = runs.data.workflow_runs[0].id;
            core.info(`Using workflow run ID: ${runId}`);

            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner,
              repo,
              run_id: runId,
            });

            const checkov = artifacts.data.artifacts.filter(a =>
              a.name.startsWith("checkov")
            );

            if (!checkov.length) {
              core.setFailed("No Checkov artifacts found");
              return;
            }

            core.setOutput(
              "artifacts",
              JSON.stringify(checkov.map(a => ({
                name: a.name,
                url: a.archive_download_url
              })))
            );

